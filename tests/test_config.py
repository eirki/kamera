#! /usr/bin/env python3.6
# coding: utf-8
from kamera.logger import log

from pathlib import Path
from types import SimpleNamespace

from kamera import config


try:
    import face_recognition
    from numpy import array as np_array
except ImportError:
    face_recognition = None
    np_array = None


def test_load_settings():
    dbx = MockDropbox()
    settings = config.Settings(dbx)

    assert settings.default_tz == "US/Eastern"
    assert settings.recognition_tolerance == 0.4
    assert settings.tag_swaps == {
        "Paris/10e arrondissement": "Holiday/France"
    }
    assert settings.folder_names == {
        1: "January",
        2: "February",
        3: "March",
        4: "April",
        5: "May",
        6: "June",
        7: "July",
        8: "August",
        9: "September",
        10: "October",
        11: "November",
        12: "December"
      }

    assert len(settings.locations) == 1
    location = settings.locations[0]
    assert location.name == "Paris"
    assert location.lat == 48.8566
    assert location.lng == 2.3522
    assert len(location.spots) == 2
    spot1, spot2 = location.spots
    assert spot1.name == "Place de la Concorde"
    assert spot1.lat == 48.8662
    assert spot1.lng == 2.3242
    assert spot2.name == "10e arrondissement"
    assert spot2.lat == 48.8698
    assert spot2.lng == 2.3523

    if face_recognition is None:
        return
    assert settings.recognition_data == {
        "Biden": [np_array([0.0035027205012738705, 0.18628090620040894, 0.10046893358230591, -0.04331471398472786, -0.1273290514945984, 0.04339016228914261, -0.02113666571676731, -0.08631915599107742, 0.06917161494493484, -0.06077443063259125, 0.2425566464662552, -0.044368598610162735, -0.26247861981391907, -0.048121195286512375, 0.05546671524643898, 0.13138742744922638, -0.147533118724823, -0.06186385452747345, -0.205827996134758, -0.07173044979572296, -0.028433283790946007, -0.031216902658343315, 0.035365596413612366, -0.08131074905395508, -0.18528738617897034, -0.22777658700942993, -0.042521171271800995, -0.11038538813591003, -0.007829805836081505, -0.1583298146724701, 0.057032518088817596, -0.03660959005355835, -0.137291818857193, -0.05452488735318184, -0.04897524416446686, -0.041464827954769135, -0.026093648746609688, -0.05947260558605194, 0.13001979887485504, 0.02254832535982132, -0.17089952528476715, 0.1230708509683609, -0.0019504427909851074, 0.19735799729824066, 0.3001015782356262, -0.01108965091407299, 0.050251513719558716, -0.12173241376876831, 0.13346679508686066, -0.2429342418909073, 0.06434343755245209, 0.029125019907951355, 0.1667415052652359, 0.06233813241124153, 0.14022627472877502, -0.08945894241333008, 0.027568716555833817, 0.16619811952114105, -0.20210303366184235, 0.04205262288451195, 0.06840027868747711, -0.04070231691002846, 0.02891385555267334, -0.035600367933511734, 0.11916733533143997, 0.10995034873485565, -0.012361519038677216, -0.105374276638031, 0.1771548092365265, -0.10735056549310684, -0.10265174508094788, 0.03524911776185036, -0.0646510124206543, -0.1253858357667923, -0.3338843286037445, 0.006294227205216885, 0.2618780732154846, 0.1496288925409317, -0.28060707449913025, -0.07874573767185211, -0.05957899987697601, 0.001456225756555795 -0.07173044979572296, -0.028433283790946007, -0.031216902658343315, 0.035365596413612366, -0.08131074905395508, -0.18528738617897034, -7, 0.035281889140605927, 0.0018480848520994186, -0.06092254817485809, -0.1357658952474594, -0.05007649585604668, -0.012880949303507805, 0.22885079681873322, -0.11443307250738144, -5.420530214905739e-05, 0.22807246446609497, 0.038565777242183685, -0.1270136833190918, 0.04386264458298683, -0.024311605840921402, -0.12258945405483246, -0.0026663742028176785, -0.10682400315999985, -0.04740773141384125, -0.012806563638150692, -0.15878766775131226, -0.013640191406011581, 0.0741121768951416, -0.2612421214580536, 0.1654357612133026, -0.03447778895497322, -0.07113464921712875, -0.04625781625509262, -0.05152251571416855, 0.010735317133367062, 0.06297130882740021, 0.23709820210933685, -0.23544232547283173, 0.20465508103370667, 0.23255489766597748, -0.047081358730793, 0.06839626282453537, 0.025587815791368484, 0.058943118900060654, -0.03763582557439804, 0.03941100835800171, -0.0887133851647377, -0.1080402135848999, 0.0004277350381016731, -0.03262195363640785, 0.011845048516988754, 0.07242202758789062])],
        "Obama": [
            np_array([-0.0963406041264534, 0.12095479667186737, -0.004363386891782284, -0.07643741369247437, 0.008038338273763657, 0.019029784947633743, -0.07184699177742004, -0.0938330888748169, 0.1851886808872223, -0.09588897973299026, 0.23951099812984467, 0.0986533984541893, -0.22114630043506622, -0.13636824488639832, 0.04405270516872406, 0.1157475933432579, -0.19899378716945648, -0.0959705039858818, -0.11969153583049774, -0.12277933955192566, 0.0341687873005867, -0.0026755889412015676, 0.09203383326530457, 0.04713432863354683, -0.1273135542869568, -0.3537188172340393, -0.05034440755844116, -0.17841318249702454, -0.0031089885160326958, -0.09844552725553513, -0.06910532712936401, -0.0050375089049339294, -0.18466520309448242, -0.0985167995095253, 0.02903972566127777, -0.02174893394112587, 0.022618692368268967, 0.003210238181054592, 0.2031252384185791, 0.029996108263731003, -0.11646008491516113, 0.09432908147573471, 0.027743440121412277, 0.22102893888950348, 0.26725172996520996, 0.06896866858005524, -0.004900233820080757, -0.09441827237606049, 0.11115386337041855, -0.22592414915561676, 0.062308572232723236, 0.1655932366847992, 0.06232891604304314, 0.03458835184574127, 0.09459751099348068, -0.18777155876159668, 0.006542385555803776, 0.08582545816898346, -0.13578271865844727, 0.01502288319170475, 0.006708355620503426, -0.08195842802524567, -0.043465036898851395, 0.03347830846905708, 0.2031015157699585, 0.09987708926200867, -0.123705193400383, -0.06683620810508728, 0.12704911828041077, -0.021608058363199234, 0.009846833534538746, 0.007662867195904255, -0.1898059993982315, -0.1964145302772522, -0.2280077487230301, 0.09010901302099228, 0.3917854428291321, 0.18818049132823944, -0.20875389873981476, 0.030970273539423943, -0.2130061537027359, 0.025324109941720963, 0.07938636839389801, 0.010007049888372421, -0.07719778269529343, -0.1265188455581665, -0.043185897171497345, 0.06219771131873131, 0.09163869917392731, 0.05039064958691597, -0.049223825335502625, 0.21839411556720734, -0.023944387212395668, 0.061737921088933945, 0.029252631589770317, 0.06160803884267807, -0.15553990006446838, -0.024406222626566887, -0.17509374022483826, -0.06304864585399628, 0.01428222842514515, -0.03637424111366272, 0.039712365716695786, 0.1398317813873291, -0.23006804287433624, 0.04999547824263573, 0.010845363140106201, -0.039709024131298065, 0.025017771869897842, 0.08157800883054733, -0.03224044665694237, -0.04502576217055321, 0.055699422955513, -0.24374927580356598, 0.2551428973674774, 0.24795185029506683, 0.04060185328125954, 0.17597420513629913, 0.07966683059930801, 0.01920103281736374, -0.011943764984607697, -0.02300819754600525, -0.17204901576042175, -0.05965585634112358, 0.053074829280376434, 0.07417038828134537, 0.07126566767692566, 0.002097971737384796]),
            np_array([-0.0963406041264534, 0.12095479667186737, -0.004363386891782284, -0.07643741369247437, 0.008038338273763657, 0.019029784947633743, -0.07184699177742004, -0.0938330888748169, 0.1851886808872223, -0.09588897973299026, 0.23951099812984467, 0.0986533984541893, -0.22114630043506622, -0.13636824488639832, 0.04405270516872406, 0.1157475933432579, -0.19899378716945648, -0.0959705039858818, -0.11969153583049774, -0.12277933955192566, 0.0341687873005867, -0.0026755889412015676, 0.09203383326530457, 0.04713432863354683, -0.1273135542869568, -0.3537188172340393, -0.05034440755844116, -0.17841318249702454, -0.0031089885160326958, -0.09844552725553513, -0.06910532712936401, -0.0050375089049339294, -0.18466520309448242, -0.0985167995095253, 0.02903972566127777, -0.02174893394112587, 0.022618692368268967, 0.003210238181054592, 0.2031252384185791, 0.029996108263731003, -0.11646008491516113, 0.09432908147573471, 0.027743440121412277, 0.22102893888950348, 0.26725172996520996, 0.06896866858005524, -0.004900233820080757, -0.09441827237606049, 0.11115386337041855, -0.22592414915561676, 0.062308572232723236, 0.1655932366847992, 0.06232891604304314, 0.03458835184574127, 0.09459751099348068, -0.18777155876159668, 0.006542385555803776, 0.08582545816898346, -0.13578271865844727, 0.01502288319170475, 0.006708355620503426, -0.08195842802524567, -0.043465036898851395, 0.03347830846905708, 0.2031015157699585, 0.09987708926200867, -0.123705193400383, -0.06683620810508728, 0.12704911828041077, -0.021608058363199234, 0.009846833534538746, 0.007662867195904255, -0.1898059993982315, -0.1964145302772522, -0.2280077487230301, 0.09010901302099228, 0.3917854428291321, 0.18818049132823944, -0.20875389873981476, 0.030970273539423943, -0.2130061537027359, 0.025324109941720963, 0.07938636839389801, 0.010007049888372421, -0.07719778269529343, -0.1265188455581665, -0.043185897171497345, 0.06219771131873131, 0.09163869917392731, 0.05039064958691597, -0.049223825335502625, 0.21839411556720734, -0.023944387212395668, 0.061737921088933945, 0.029252631589770317, 0.06160803884267807, -0.15553990006446838, -0.024406222626566887, -0.17509374022483826, -0.06304864585399628, 0.01428222842514515, -0.03637424111366272, 0.039712365716695786, 0.1398317813873291, -0.23006804287433624, 0.04999547824263573, 0.010845363140106201, -0.039709024131298065, 0.025017771869897842, 0.08157800883054733, -0.03224044665694237, -0.04502576217055321, 0.055699422955513, -0.24374927580356598, 0.2551428973674774, 0.24795185029506683, 0.04060185328125954, 0.17597420513629913, 0.07966683059930801, 0.01920103281736374, -0.011943764984607697, -0.02300819754600525, -0.17204901576042175, -0.05965585634112358, 0.053074829280376434, 0.07417038828134537, 0.07126566767692566, 0.002097971737384796])
        ]
    }


class MockDropbox:
    def files_download(self, path: Path):
        with open(path, "rb") as file:
            data = file.read()
        filemetadata = None
        response = SimpleNamespace(raw=SimpleNamespace(data=data))
        return filemetadata, response
